<%inherit file="../base.html"/>
<%block name="content">
    <div class="king-content-wrap">
        <div class="king-layout1-content" style="margin-left: 216px;">
            <div class="king-tab tab-box ">
                <ul id="myTab2" class="nav nav-tabs king-nav-tabs1 king-tab-info">
                    <li class="active"> <a id="query_result" data-toggle="tab" href="#demo1" aria-expanded="true">查询结果</a> </li>
                    <li class=""> <a data-toggle="tab" href="#demo2" aria-expanded="false" onclick="get_menu_version_success()">发版成功</a> </li>
                    <li class=""> <a data-toggle="tab" href="#demo3" aria-expanded="false" onclick="get_menu_version_fail()">发版失败</a> </li>
                    <li class=""> <a data-toggle="tab" href="#instruction" aria-expanded="false">使用说明</a> </li>
                </ul>
                <div class="tab-content ">
                    <div class="tab-pane fade active in" id="demo1" style="">
                        <div class="panel panel-default mb0">
                            <div class="panel-heading">
                                <button type="button" class="king-btn mr10 king-success" id="query_by_id">查询</button>
                                <button type="button" class="king-btn mr10 king-success" id="newversion">发版</button>

                            </div>
                            <div class="panel-body">
                                <table id="code_1527301039797" class="table mb0 pr15 ranger-box ">
                                    <thead>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                                <!-- 设置面板Start -->
                                <template id="header_tpl_1527301039797">
                                    <tr>
                                        <th style="width: 100px;">#index#</th>
                                        <th style="width: 20%;">#task#</th>
                                        <th style="width: 20%;">#progress#</th>
                                        <th style="width: 20%;">#host#</th>
                                        <th>#date#</th>
                                        <th>选择菜单版本</th>
                                    </tr>
                                </template>
                                <template id="tpl_1527301039797">
                                    <tr>
                                        <td style="width: 100px;">#index#</td>
                                        <td style="width: 20%;">#columnName1#</td>
                                        <td style="width: 20%;">#columnName2#</td>
                                        <td style="width: 20%;">#columnName3#</td>
                                        <td>#columnName4#</td>
                                        <td>
                                            <select id="#columnName1#" class="menu_version_select" name="" >

                                            </select>
                                        </td>
                                    </tr>
                                </template>
                                <!-- 设置面板End -->
                            </div>
                        </div>
                    </div>
##                     已发版标签页
                    <div class="tab-pane fade" id="demo2" style="">
                          <div class="king-block king-block-bordered">
                            <div class="king-block-header king-gray-light">
                                <h3 class="king-block-title">综合示例</h3>
                            </div>
                            <div class="king-block-content">
                              <table id="new_version_success_table" class="table table-bordered table-striped">
                                <thead>
                                  <tr>
                                    <th>门店ID</th>
                                    <th>门店名称</th>
                                    <th>操作时间</th>
                                    <th>菜单版本</th>
##                                     <th>位置</th>
##                                     <th>分机号</th>
                                    <th>操作</th>
                                  </tr>
                                </thead>
                              </table>
                            </div>
                          </div>
                    </div>
##                     未发版标签页
                    <div class="tab-pane fade" id="demo3" style="">
                        <div class="king-block king-block-bordered">
                            <div class="king-block-header king-gray-light">
                                <button class="king-btn mr10 king-success" id="recheck">重新检查</button>
                            </div>
                            <div class="king-block-content">
                              <table id="new_version_fail_table" class="table table-bordered table-striped">
                                <thead>
                                  <tr>
                                    <th>门店ID</th>
                                    <th>门店名称</th>
                                    <th>操作时间</th>
                                    <th>菜单版本</th>
                                    <th>操作</th>
                                  </tr>
                                </thead>
                              </table>
                            </div>
                        </div>

                    </div>
                    <div class="tab-pane fade" id="instruction" style="">
                        <div class="king-block king-block-bordered">
                            <div class="king-block-header king-gray-light">
                                <h3 class="king-block-title">使用说明</h3>
                            </div>
                            <div class="king-block-content">
                                <div class="king-instruction king-instruction-info">
                                    <h5>使用说明</h5>
                                    <p>1、您可以在查询页中，填入门店ID。点击提交后，可以查询到门店名称以及检查项的检查结果。</p>
                                    <p>2、点击【发版】按钮后，可以在【发版成功】页中找到发版成功的记录。可以在发版失败页中找到发版失败的记录。</p>
                                    <p>3、每个门店只能发版一次，重复发版会有错误提示。</p>
                                    <p>4、可以在【发版失败】页中重新选择门店进行检查。</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

            <!-- content end -->
    <script>
##         用于处理【发版】的按钮的返回结果
        function new_version_ret(res) {
            dstore = res.duplicated_store
            success_store = res.success_store
            fail_store = res.fail_store
            showstr = ""
            if(JSON.stringify(dstore) != "{}"){
                showstr = "以下门店重复发版：</br>"
                for (var key in dstore){
                    showstr += key + ":" + dstore[key] + "</br>"
                }
                showstr += "</br>"
            }

            if(JSON.stringify(success_store) != "{}"){
                showstr += "以下门店发版成功：</br>"
                for (var key in success_store){
                    showstr += key + ":" + success_store[key] +"</br>"
                }
                showstr += "</br>"

            }

            if(JSON.stringify(fail_store) != "{}"){
                showstr += "以下门店发版失败：</br>"
                for (var key in fail_store){
                    showstr += key + ":" + fail_store[key] +"</br>"
                }
            }

            myutils.successAlert("发版结果",showstr)
        }
         ## 输入门店ID，检查
         $('#query_by_id').click(function _storecheck () {
            content_html = "    <div class=\"king-page-box\">\n" +
                "        <div class=\"king-container clearfix\">\n" +
                "            <form class=\"form-horizontal\">\n" +
                "                <div class=\"form-group has-feedback clearfix \">\n" +
                "                    <label class=\"control-label col-sm-2 pt0\" for=\"introduction\">门店ID：</label>\n" +
                "                    <div class=\"col-sm-10\">\n" +
                "                        <textarea id=\"store_ids\" class=\"form-control\" rows=\"6\" placeholder=\"填入以逗号分隔的6位数字\"></textarea>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "            </form>\n" +
                "        </div>\n" +
                "    </div>"
            var d = dialog({
            width: 600,
            title: '填入门店ID',
            cancel: function (){},
            ok: function() {
                store_id_array = $('#store_ids').val().split(',')
                if(store_id_array == ""){
                    myutils.errorAlert("门店ID不能为空")
                    return
                }else if(!myutils.isArrayItemNo(store_id_array)){
                    myutils.errorAlert("非正常门店ID，门店ID必须是1个或多个6位数字，并且以英文逗号分隔。")
                    return
                }
                ##  window.location.href=site_url + 'test_application/new_version?store_ids=' + store_id_array
                function renderTpl(str, cfg) {
                    var re = /(#(.+?)#)/g;

                    return str.replace(re, function() {
                        var val = cfg[arguments[2]]+'';
                        if(typeof val == 'undefined') {
                            val = '';
                        }
                        return val;
                    });
                }

                // 异步请求后台数据
                $.ajax({
                    url: site_url + 'check_storeids',
                    data: {data: store_id_array},
                    type: 'GET',
                    success: function(res){
                        var _html = ' ';
                        var list = res.items;
                        var tpl = $('#tpl_1527301039797').html();
                        var headerTpl =  $('#header_tpl_1527301039797').html();
                        for (var i=0,len=list.length; i < len; i++){
                            var item = list[i];
                            _html += renderTpl(tpl, item)
                        }
                        ## 填入内容
                        $('#code_1527301039797 tbody').html(_html);
                        ## 填入头部
                        $('#code_1527301039797 thead').html(renderTpl(headerTpl,res.catalogues));
                        $.get(site_url + 'get_menu_version', {}, function (res) {
                            for (var key in res.data){
                                $('.menu_version_select').append("<option value=" + key + ">" + res.data[key] + "</option>")
                            }
                        })
                        ## 发版操作
                        $('#newversion').unbind('click')
                        $('#newversion').click(function () {
                            ## 获取每个门店对应的菜单版本
                            selectid = $('.menu_version_select option:selected').val()
                            for(var index in list){
                                menu_version_id = $('#' + list[index]['columnName1'] + " option:selected").val()
                                list[index]['menu_version_id']=menu_version_id
                            }
                            $.get(site_url + "new_menu", {data: JSON.stringify(list)}, function (res) {
                                new_version_ret(res)
                            })
                        })

                    }
                });
            },
            okValue: '检查',
            content: content_html,
            cancelValue: '取消',
            cancel: function() {

            }
            });
            d.show();
        })
    </script>
    <script>
    $(function(){

        });
    </script>

##     已发版成功标签页
    <script type="text/javascript">
      function get_menu_version_success() {
        //new_version_success_table_js_start
        //表格(DataTables)-4，综合示例
        var language = {
          search: '搜索：',
          lengthMenu: "每页显示 _MENU_ 记录",
          zeroRecords: "没找到相应的数据！",
          info: "分页 _PAGE_ / _PAGES_",
          infoEmpty: "暂无数据！",
          infoFiltered: "(从 _MAX_ 条数据中搜索)",
          paginate: {
            first: '首页',
            last: '尾页',
            previous: '上一页',
            next: '下一页',
          }
        }
        $("#new_version_success_table").dataTable({
            destroy: true,
            autoWidth: false,
            lengthChange: true, //不允许用户改变表格每页显示的记录数
            pageLength : 5, //每页显示几条数据
            lengthMenu: [5, 10, 20], //每页显示选项
            pagingType: 'full_numbers',
            ajax : site_url + 'get_new_version_success',
            ordering: true,
            columns : [
              {data:"storeid",orderable: false},
              {data:"storename"},
              {data:"create_time"},
              {data:"menu_version"},
              ##  {data:"office"},
              ##  {data:"extn"},
              {
                data:null,
                orderable:false,
                render : function(data, type, row, meta){
                    return '<a class="king-btn king-default del">删除</a>';
                }
              }
            ],
            language:language
        });

        var t = $("#new_version_success_table").DataTable();//获取datatables对象
        //删除按钮绑定事件
        $("#new_version_success_table tbody").on('click', 'a.del', function(){
            var row = t.row( $(this).parents('tr') ),//获取按钮所在的行
              data = row.data();
            if(confirm('确定要删除'+data.name+' ?')){
              row.remove().draw();
            }

        });
        //new_version_success_table_js_end
      };
      ##  未发版成功标签页start
      function get_menu_version_fail() {
        var language = {
          search: '搜索：',
          lengthMenu: "每页显示 _MENU_ 记录",
          zeroRecords: "没找到相应的数据！",
          info: "分页 _PAGE_ / _PAGES_",
          infoEmpty: "暂无数据！",
          infoFiltered: "(从 _MAX_ 条数据中搜索)",
          paginate: {
            first: '首页',
            last: '尾页',
            previous: '上一页',
            next: '下一页',
          }
        }
        $("#new_version_fail_table").dataTable({
            destroy: true,
            autoWidth: false,
            lengthChange: true, //不允许用户改变表格每页显示的记录数
            pageLength : 5, //每页显示几条数据
            lengthMenu: [5, 10, 20], //每页显示选项
            pagingType: 'full_numbers',
            ajax : site_url + 'get_new_version_fail',
            ordering: true,
            columns : [
              {data:"storeid",orderable: false},
              {data:"storename"},
              {data:"create_time"},
              {data:"menu_version"},
              {
                data:null,
                orderable:false,
                render : function(data, type, row, meta){
                    return '<a class="king-btn king-default del">删除</a>';
                }
              }
            ],
            language:language
        });

        var t = $("#new_version_fail_table").DataTable();//获取datatables对象
         $('#new_version_fail_table tbody').on('click', 'tr', function () {
            $(this).toggleClass('selected');
         });
        //删除按钮绑定事件
        $("#new_version_fail_table tbody").on('click', 'a.del', function(){
            var row = t.row( $(this).parents('tr') ),//获取按钮所在的行
              data = row.data();
            if(confirm('确定要删除'+data.name+' ?')){
              row.remove().draw();
            }

        });

        $('#recheck').unbind('click')
         $('#recheck').click(function () {
             ##  alert( t.rows('.selected').data().length +' row(s) selected' );
##              切换到【检查结果】页
             $('#query_result').tab('show')
             ## 获取选择的门店ID
             store_data = t.rows('.selected').data()
             recheck_store_id_array = []
             for( var i=0; i< store_data.length; i++){
                 recheck_store_id_array.push(store_data[i].storeid)
             }
             ## 删除这些门店ID的记录
             $.get(site_url + "del_new_version_log", {data: recheck_store_id_array}, function (res) {

             })
             function renderTpl(str, cfg) {
                var re = /(#(.+?)#)/g;

                return str.replace(re, function() {
                    var val = cfg[arguments[2]]+'';
                    if(typeof val == 'undefined') {
                        val = '';
                    }
                    return val;
                });
            }

             $.ajax({
                url: site_url + 'check_storeids',
                data: {data: recheck_store_id_array},
                type: 'GET',
                success: function(res){
                    var _html = ' ';
                    var list = res.items;
                    var tpl = $('#tpl_1527301039797').html();
                    var headerTpl =  $('#header_tpl_1527301039797').html();
                    for (var i=0,len=list.length; i < len; i++){
                        var item = list[i];
                        _html += renderTpl(tpl, item)
                    }
                    ## 填入内容
                    $('#code_1527301039797 tbody').html(_html);
                    ## 填入头部
                    $('#code_1527301039797 thead').html(renderTpl(headerTpl,res.catalogues));
                    $.get(site_url + 'get_menu_version', {}, function (res) {
                        for (var key in res.data){
                            $('.menu_version_select').append("<option value=" + key + ">" + res.data[key] + "</option>")
                        }
                    })
                    ## 发版操作
                    $('#newversion').unbind('click')
                    $('#newversion').click(function () {
                        ## 获取每个门店对应的菜单版本
                        selectid = $('.menu_version_select option:selected').val()
                        for(var index in list){
                            menu_version_id = $('#' + list[index]['columnName1'] + " option:selected").val()
                            list[index]['menu_version_id']=menu_version_id
                        }
                        $.get(site_url + "new_menu", {data: JSON.stringify(list)}, function (res) {
                            new_version_ret(res)
                        })
                    })

                }
             });
         });
      };
      //##  未发版成功标签页end
    </script>

</%block>

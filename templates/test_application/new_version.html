<%inherit file="../base.html"/>
<%block name="content">
    <div class="king-content-wrap">
        <div class="king-layout1-content" style="margin-left: 216px;">
            <div class="king-tab tab-box ">
                <ul id="myTab2" class="nav nav-tabs king-nav-tabs1 king-tab-info">
                    <li class="active"> <a data-toggle="tab" href="#demo1" aria-expanded="true">查询结果</a> </li>
                    <li class=""> <a data-toggle="tab" href="#demo2" aria-expanded="false">已发版</a> </li>
                    <li class=""> <a data-toggle="tab" href="#demo3" aria-expanded="false">未发版</a> </li>
                </ul>
                <div class="tab-content ">
                    <div class="tab-pane fade active in" id="demo1" style="">
                        <div class="panel panel-default mb0">
                            <div class="panel-heading">
                                <button type="button" class="king-btn mr10 king-success" id="newversion">发版</button>
                            </div>
                            <div class="panel-body">
                                <table id="code_1527301039797" class="table mb0 pr15 ranger-box ">
                                    <thead>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                                <!-- 设置面板Start -->
                                <template id="header_tpl_1527301039797">
                                    <tr>
                                        <th style="width: 100px;">#index#</th>
                                        <th style="width: 20%;">#task#</th>
                                        <th style="width: 20%;">#progress#</th>
                                        <th style="width: 20%;">#host#</th>
                                        <th>#date#</th>
                                        <th>选择菜单版本</th>
                                    </tr>
                                </template>
                                <template id="tpl_1527301039797">
                                    <tr>
                                        <td style="width: 100px;">#index#</td>
                                        <td style="width: 20%;">#columnName1#</td>
                                        <td style="width: 20%;">#columnName2#</td>
                                        <td style="width: 20%;">#columnName3#</td>
                                        <td>#columnName4#</td>
                                        <td>
                                            <select id="#columnName1#" class="menu_version_select" name="" >

                                            </select>
                                        </td>
                                    </tr>
                                </template>
                                <!-- 设置面板End -->
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="demo2" style="">
                          <div class="king-block king-block-bordered">
                            <div class="king-block-header king-gray-light">
                                <h3 class="king-block-title">综合示例</h3>
                            </div>
                            <div class="king-block-content">
                              <table id="table2_demo4" class="table table-bordered table-striped">
                                <thead>
                                  <tr>
                                    <th>名称</th>
                                    <th>职位</th>
                                    <th>工资</th>
                                    <th>开始时间</th>
                                    <th>位置</th>
                                    <th>分机号</th>
                                    <th>操作</th>
                                  </tr>
                                </thead>
                              </table>
                            </div>
                          </div>
                    </div>
                    <div class="tab-pane fade" id="demo3" style=""> </div>
                </div>
            </div>
        </div>
    </div>

            <!-- content end -->
    <script>
        content_html = "    <div class=\"king-page-box\">\n" +
            "        <div class=\"king-container clearfix\">\n" +
            "            <form class=\"form-horizontal\">\n" +
            "                <div class=\"form-group has-feedback clearfix \">\n" +
            "                    <label class=\"control-label col-sm-2 pt0\" for=\"introduction\">门店ID：</label>\n" +
            "                    <div class=\"col-sm-10\">\n" +
            "                        <textarea id=\"store_ids\" class=\"form-control\" rows=\"6\" placeholder=\"填入以逗号分隔的6位数字\"></textarea>\n" +
            "                    </div>\n" +
            "                </div>\n" +
            "            </form>\n" +
            "        </div>\n" +
            "    </div>"
        var d = dialog({
        width: 600,
        title: '填入门店ID',
        cancel: function (){},
        ok: function() {
            store_id_array = $('#store_ids').val().split(',')
            if(store_id_array == ""){
                errorAlert("门店ID不能为空")
                return
            }else if(!myutils.isArrayItemNo(store_id_array)){
                errorAlert("非正常门店ID，门店ID必须是1个或多个6位数字，并且以英文逗号分隔。")
                return
            }
            ##  window.location.href=site_url + 'test_application/new_version?store_ids=' + store_id_array
            function renderTpl(str, cfg) {
                var re = /(#(.+?)#)/g;

                return str.replace(re, function() {
                    var val = cfg[arguments[2]]+'';
                    if(typeof val == 'undefined') {
                        val = '';
                    }
                    return val;
                });
            }

            // 异步请求后台数据
            $.ajax({
                url: site_url + 'check_storeids',
                data: {data: store_id_array},
                type: 'GET',
                success: function(res){
                    var _html = ' ';
                    var list = res.items;
                    var tpl = $('#tpl_1527301039797').html();
                    var headerTpl =  $('#header_tpl_1527301039797').html();
                    for (var i=0,len=list.length; i < len; i++){
                        var item = list[i];
                        _html += renderTpl(tpl, item)
                    }
                    ## 填入内容
                    $('#code_1527301039797 tbody').html(_html);
                    ## 填入头部
                    $('#code_1527301039797 thead').html(renderTpl(headerTpl,res.catalogues));
                    $.get(site_url + 'get_menu_version', {}, function (res) {
                        for (var key in res.data){
                            $('.menu_version_select').append("<option value=" + key + ">" + res.data[key] + "</option>")
                        }
                    })
                    ## 发版操作
                    $('#newversion').click(function () {
                        ## 获取每个门店对应的菜单版本
                        selectid = $('.menu_version_select option:selected').val()
                        for(var index in list){
                            menu_version_id = $('#' + list[index]['columnName1'] + " option:selected").val()
                            list[index]['menu_version_id']=menu_version_id
                        }
                        $.get(site_url + "new_menu", {data: JSON.stringify(list)}, function (res) {
                            
                        })
                    })

                }
            });
        },
        okValue: '检查',
        content: content_html,
        cancelValue: '取消',
        cancel: function() {

        }
        });
        d.show();
    </script>
    <script>
    $(function(){

        });
    </script>

##     未发版成功标签页
    <script type="text/javascript">
      $(function () {
        //table2_demo4_js_start
        //表格(DataTables)-4，综合示例
        var language = {
          search: '搜索：',
          lengthMenu: "每页显示 _MENU_ 记录",
          zeroRecords: "没找到相应的数据！",
          info: "分页 _PAGE_ / _PAGES_",
          infoEmpty: "暂无数据！",
          infoFiltered: "(从 _MAX_ 条数据中搜索)",
          paginate: {
            first: '首页',
            last: '尾页',
            previous: '上一页',
            next: '下一页',
          }
        }
        $("#table2_demo4").dataTable({
            autoWidth: false,
            lengthChange: true, //不允许用户改变表格每页显示的记录数
            pageLength : 5, //每页显示几条数据
            lengthMenu: [5, 10, 20], //每页显示选项
            pagingType: 'full_numbers',
            ajax : static_url + 'tmp/data.json',
            ordering: true,
            columns : [
              {data:"name",orderable: false},
              {data:"position"},
              {data:"salary"},
              {data:"start_date"},
              {data:"office"},
              {data:"extn"},
              {
                data:null,
                orderable:false,
                render : function(data, type, row, meta){
                    return '<a class="king-btn king-default del">删除</a>';
                }
              }
            ],
            language:language
        });

        var t = $("#table2_demo4").DataTable();//获取datatables对象
        //删除按钮绑定事件
        $("#table2_demo4 tbody").on('click', 'a.del', function(){
            var row = t.row( $(this).parents('tr') ),//获取按钮所在的行
              data = row.data();
            if(confirm('确定要删除'+data.name+' ?')){
              row.remove().draw();
            }

        });
        //table2_demo4_js_end
      });
    </script>

</%block>
